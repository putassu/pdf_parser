import json
import config

def get_tuning_prompt(payload, attempt_num):
    return f"""
Ты — AI-аудитор структуры документов. Твоя задача: оценить качество сегментации Excel-файла на логические блоки.
Это попытка №{attempt_num} из {config.XLSX_PARSER_NUM_RETRIES}.

БИБЛИОТЕКА ТИПОВ:
{json.dumps(config.BLOCK_TYPES_LIBRARY, indent=2, ensure_ascii=False)}

АНАЛИЗИРУЕМЫЕ ДАННЫЕ (Превью блоков):
{json.dumps(payload, indent=2, ensure_ascii=False)}

ТВОИ ЗАДАЧИ:
1. Вычисли quality_score (от 0.0 до 1.0) для всего документа.
   - 1.0: Идеально. Каждый блок содержит только один тип данных.
   - 0.5: ОШИБКА "Склейка". Внутри одного блока (например, в начале и конце) разные типы данных (напр. Анкета и Таблица).
   - 0.5: ОШИБКА "Распад". Одна логическая таблица разбита на множество мелких блоков.
2. Если score < 0.9, предложи смену пресета:
   - "Tight": если нужно разрезать склеенные блоки (уменьшить допуски).
   - "Relaxed": если нужно объединить распавшиеся части (увеличить допуски).
3. Если score >= 0.9 или это последняя попытка — пиши action: "stop".

ОТВЕТЬ ТОЛЬКО JSON:
{{
  "quality_score": 0.0-1.0,
  "action": "reparse" или "stop",
  "reason": "техническое обоснование",
  "sheets": {{
     "ИмяЛиста": {{
        "summaries": ["Краткое описание структуры листа"],
        "recommended_preset": "Tight" или "Standard" или "Relaxed"
     }}
  }}
}}
"""
